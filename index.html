<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Links</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0c29;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text-color: #ffffff;
            --accent: #00d2ff;
            --navbar-height: 60px;
        }
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: calc(var(--navbar-height) + 30px);
            padding-bottom: 40px;
        }

        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--navbar-height);
            background: rgba(15, 12, 41, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .nav-logo {
            font-size: 1.2rem; font-weight: 600; color: #fff; text-decoration: none;
            display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px;
        }
        .nav-logo i { color: var(--accent); font-size: 1.1rem; }
        .nav-logo span { background: linear-gradient(90deg, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .nav-user-container { display: flex; align-items: center; gap: 10px; }
        .nav-profile-img {
            width: 38px; height: 38px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            object-fit: cover; cursor: pointer; transition: transform 0.3s;
            background: #fff;
        }
        .nav-profile-img:hover { transform: scale(1.1); border-color: var(--accent); }

        .profile-section { text-align: center; margin-bottom: 25px; animation: fadeIn 0.8s ease; }
        .profile-img {
            width: 120px; height: 120px; border-radius: 50%;
            border: 3px solid var(--accent); padding: 4px; object-fit: cover;
            margin-bottom: 15px; box-shadow: 0 0 30px rgba(0, 210, 255, 0.3);
        }
        h1 { margin: 0; font-size: 1.8rem; font-weight: 600; }
        p.bio { opacity: 0.7; margin-top: 5px; font-weight: 300; font-size: 0.95rem; }

        .video-container {
            width: 90%; max-width: 500px; margin-bottom: 25px; display: none; animation: fadeIn 1s ease;
        }
        .video-wrapper {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #000;
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .container { width: 90%; max-width: 500px; padding-bottom: 60px; display: flex; flex-direction: column; gap: 14px; }
        
        .link-card {
            background: var(--card-bg); backdrop-filter: blur(10px); padding: 16px 20px;
            border-radius: 16px; text-decoration: none; color: white; display: flex; align-items: center;
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.25s ease; position: relative; overflow: hidden;
        }
        .link-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.15); border-color: rgba(255,255,255,0.5); }
        .link-card.special-access { background: rgba(0, 210, 255, 0.15); border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }
        
        .group-divider { display: flex; align-items: center; color: var(--accent); font-size: 0.9rem; margin: 10px 0 5px 0; font-weight: 500; }
        .group-divider::before, .group-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.2); }
        .group-divider span { padding: 0 10px; }

        .link-icon { font-size: 1.6rem; margin-right: 18px; width: 35px; text-align: center; }
        .fa-facebook { color: #1877F2; } .fa-youtube { color: #FF0000; } .fa-instagram { color: #E4405F; }
        .fa-line { color: #00C300; } .fa-tiktok { color: #ff0050; filter: drop-shadow(2px 2px 0px #00f2ea); }
        .fa-google-drive { color: #1FA463; } .fa-github { color: #ffffff; } .fa-envelope { color: #FFC107; }
        .fa-link { color: var(--accent); }
        .link-text { font-size: 1.05rem; font-weight: 500; }
        .badge { margin-left: auto; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; text-transform: uppercase; }
        .badge-vip { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; }

        .unlock-btn {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            color: #aaa; border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; z-index: 100;
        }
        .unlock-btn.active { color: #00d2ff; border-color: #00d2ff; background: rgba(0, 210, 255, 0.1); }
        .admin-link { margin-top: auto; color: rgba(255,255,255,0.2); text-decoration: none; font-size: 0.8rem; padding-bottom: 20px; }
        .admin-link:hover { color: var(--accent); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="#" class="nav-logo">
            <i class="fas fa-link"></i>
            <span>Koo Mean Links</span>
        </a>
        
        <div class="nav-user-container" onclick="window.location.href='admin.html'">
            <img id="nav-profile-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="nav-profile-img" alt="User">
        </div>
    </nav>

    <div class="profile-section" id="profile-section"></div>

    <div class="video-container" id="featured-video">
        <div class="video-wrapper">
            <iframe id="youtube-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>

    <div class="container" id="links-container">
        <div style="text-align: center; opacity: 0.5;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <a href="admin.html" class="admin-link"><i class="fas fa-cog"></i> Manage</a>

    <button class="unlock-btn" id="unlockBtn" onclick="handleUnlock()">
        <i class="fas fa-lock"></i>
    </button>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // ‚ö†Ô∏è ‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const firebaseConfig = {
            apiKey: "AIzaSyB-Brx6cQ7dFhQqbEhDG4xIT4jcVG1yogs",
  authDomain: "mylinks-web.firebaseapp.com",
  projectId: "mylinks-web",
  storageBucket: "mylinks-web.firebasestorage.app",
  messagingSenderId: "702413304222",
  appId: "1:702413304222:web:d255e6c2f428bb1e1d668f",
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentAccessGroup = 'public';
        let accessRules = {};
        let adminProfileImage = ''; 
        let userImagesMap = {};

        function loadData() {
            db.doc("settings/profile").get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    renderProfile(data);
                    renderVideo(data.featuredVideo);
                    
                    adminProfileImage = data.navbarAdminImage;
                    
                    // ‡πÇ‡∏´‡∏•‡∏î config ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ó‡∏±‡πâ‡∏á Email ‡πÅ‡∏•‡∏∞ Group)
                    if (data.userImagesConfig) {
                        data.userImagesConfig.split('\n').forEach(line => {
                            const splitIndex = line.indexOf(':');
                            if (splitIndex > 0) {
                                const key = line.substring(0, splitIndex).trim(); // key ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô email ‡∏´‡∏£‡∏∑‡∏≠ group name
                                const url = line.substring(splitIndex + 1).trim();
                                if(key && url) userImagesMap[key] = url;
                            }
                        });
                    }

                    if (data.accessConfig) {
                        data.accessConfig.split('\n').forEach(line => {
                            const [code, group] = line.split(':');
                            if(code && group) accessRules[code.trim()] = group.trim();
                        });
                    }

                    checkAuthStatus();
                }
            });

            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            db.collection("links").orderBy("order", "asc").get().then((snapshot) => {
                const container = document.getElementById('links-container');
                container.innerHTML = ''; 
                let allLinks = [];
                snapshot.forEach(doc => allLinks.push(doc.data()));

                const visibleLinks = allLinks.filter(link => {
                    const groupString = link.group || 'public';
                    const allowedGroups = groupString.split(',').map(g => g.trim());
                    return allowedGroups.includes('public') || allowedGroups.includes(currentAccessGroup);
                });

                const specialLinks = visibleLinks.filter(link => {
                    const groupString = link.group || 'public';
                    const allowedGroups = groupString.split(',').map(g => g.trim());
                    return !allowedGroups.includes('public') && allowedGroups.includes(currentAccessGroup);
                });
                
                const publicLinks = visibleLinks.filter(link => {
                     const groupString = link.group || 'public';
                     return groupString.includes('public');
                });

                if (specialLinks.length > 0) {
                    container.innerHTML += `<div class="group-divider"><span>üîì ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${currentAccessGroup.toUpperCase()}</span></div>`;
                    specialLinks.forEach(link => renderLink(container, link, true));
                }
                if (publicLinks.length > 0) {
                    if (specialLinks.length > 0) container.innerHTML += `<div class="group-divider"><span>üåç ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</span></div>`;
                    publicLinks.forEach(link => renderLink(container, link, false));
                }
            });
        }

        function checkAuthStatus() {
            const user = auth.currentUser;
            updateNavbarUI(user);
        }

        auth.onAuthStateChanged((user) => {
            updateNavbarUI(user);
        });

        function updateNavbarUI(user) {
            const navImg = document.getElementById('nav-profile-img');
            
            if (user) {
                // 1. Admin Login (‡πÄ‡∏ä‡πá‡∏Ñ Email)
                if (userImagesMap[user.email]) {
                    navImg.src = userImagesMap[user.email];
                } else if (adminProfileImage) {
                    navImg.src = adminProfileImage;
                } else {
                    navImg.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
                }
                navImg.style.borderColor = "#00d2ff";
            } else {
                // 2. Guest (‡πÄ‡∏ä‡πá‡∏Ñ Group Code)
                if (currentAccessGroup !== 'public' && userImagesMap[currentAccessGroup]) {
                    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏£‡∏π‡∏õ -> ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°
                    navImg.src = userImagesMap[currentAccessGroup];
                    navImg.style.borderColor = "#ffbd00"; // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á
                } else {
                    // Guest ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                    navImg.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; 
                    navImg.style.borderColor = "rgba(255,255,255,0.2)";
                }
            }
        }

        function renderProfile(data) {
            document.getElementById('profile-section').innerHTML = `
                <img src="${data.imageUrl || 'https://ui-avatars.com/api/?name=User'}" class="profile-img">
                <h1>${data.name || 'My Links'}</h1>
                <p class="bio">${data.bio || ''}</p>
            `;
        }

        function renderVideo(url) {
            const videoContainer = document.getElementById('featured-video');
            const iframe = document.getElementById('youtube-iframe');
            if (url) {
                const videoId = extractVideoID(url);
                if (videoId) {
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    videoContainer.style.display = 'block';
                } else { videoContainer.style.display = 'none'; }
            } else { videoContainer.style.display = 'none'; }
        }

        function extractVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function renderLink(container, link, isSpecial) {
            const iconClass = link.icon || 'fas fa-link';
            const specialClass = isSpecial ? 'special-access' : '';
            const badge = isSpecial ? `<span class="badge badge-vip">${currentAccessGroup}</span>` : '';

            const html = `
                <a href="${link.url}" target="_blank" class="link-card ${specialClass}">
                    <div class="link-icon"><i class="${iconClass}"></i></div>
                    <div class="link-text">${link.title}</div>
                    ${badge}
                </a>
            `;
            container.innerHTML += html;
        }

        function handleUnlock() {
            if (currentAccessGroup !== 'public') {
                // Logout
                currentAccessGroup = 'public';
                alert("üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                document.getElementById('unlockBtn').classList.remove('active');
                document.getElementById('unlockBtn').innerHTML = '<i class="fas fa-lock"></i>';
                updateNavbarUI(null); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ Navbar ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Guest
                loadData();
            } else {
                // Login
                const input = prompt("üîë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á:");
                if (input && accessRules[input]) {
                    currentAccessGroup = accessRules[input];
                    document.getElementById('unlockBtn').classList.add('active');
                    document.getElementById('unlockBtn').innerHTML = '<i class="fas fa-unlock"></i>';
                    updateNavbarUI(null); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ Navbar ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                    loadData();
                } else if (input) {
                    alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            }
        }

        loadData();
    </script>
</body>
</html>
